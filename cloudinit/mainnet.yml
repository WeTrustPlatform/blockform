#cloud-config
package_upgrade: true
users:
  - default
  - name: blockform
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    ssh_authorized_keys:
      - @@PUB_KEY@@
disk_setup:
  @@DEVICE@@:
    table_type: 'mbr'
    layout: [100]
    overwrite: true
fs_setup:
  - label: data
    filesystem: 'ext4'
    device: '@@DEVICE@@'
    partition: auto
    overwrite: true
mounts:
  - [ "@@DEVICE@@1", "/datadrive", "ext4", "defaults", "0", "2" ]
write_files:
  - owner: root:root
  - path: /lib/systemd/system/geth.service
    content: |
        [Unit]
        Description=Geth
        After=network.target
        [Service]
        Type=simple
        Restart=always
        RestartSec=10
        User=blockform
        WorkingDirectory=/home/blockform
        StandardOutput=journal
        ExecStart=/usr/bin/geth --datadir /datadrive --syncmode fast --networkid 1 --rpc --rpcapi net,eth,web3,personal --rpcaddr 127.0.0.1 --rpcport 8445 --rpccorsdomain * --rpcvhosts *
        [Install]
        WantedBy=multi-user.target
  - owner: root:root
    path: /etc/nginx/sites-available/default
    content: |
        server {
          listen 8545;
          location /@@API_KEY@@ {
            proxy_pass http://127.0.0.1:8445;
          }
        }
  - owner: root:root
    path: /etc/blockform/options-ssl-nginx.conf
    content: |
        ssl_session_cache shared:le_nginx_SSL:1m;
        ssl_session_timeout 1440m;

        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_prefer_server_ciphers on;

        ssl_ciphers "ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS";
packages:
  - nginx
runcmd:
  - chown -R blockform:blockform /datadrive
  - wget -q https://gethstore.blob.core.windows.net/builds/geth-linux-amd64-1.8.13-225171a4.tar.gz
  - tar xf geth-linux-amd64-1.8.13-225171a4.tar.gz
  - cp geth-linux-amd64-1.8.13-225171a4/geth /usr/bin/geth
  - chown -R blockform:blockform /datadrive
  - systemctl enable geth
  - systemctl start geth
  - bash -c 'if [ "@@DOMAIN@@" == "" ]; then echo $(curl -s http://169.254.169.254/latest/meta-data/public-hostname) > /etc/domain; else echo "@@DOMAIN@@" > /etc/domain; fi;'
  - export DOMAIN=$(cat /etc/domain)
  - openssl req -x509 -nodes -days 365 -newkey rsa:2048 -subj "/C=GB/ST=London/L=London/O=WeTrust/OU=BlockForm/CN=${DOMAIN}" -keyout /etc/blockform/nginx-selfsigned.key -out /etc/blockform/nginx-selfsigned.crt
  - sed -i -e "s|listen 8545;|server_name ${DOMAIN};listen [::]:8545 ssl ipv6only=on;listen 8545 ssl;ssl_certificate /etc/blockform/nginx-selfsigned.crt;ssl_certificate_key /etc/blockform/nginx-selfsigned.key;include /etc/blockform/options-ssl-nginx.conf;|g" /etc/nginx/sites-available/default
  - systemctl restart nginx
  - chown -R blockform:blockform /datadrive
